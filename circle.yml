machine:
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
    - pip install --upgrade docker-compose

  services:
    - docker

dependencies:
  override:
    - docker-compose build

test:
  override:
    - docker-compose run bot init

    - docker-compose up -d
    - sleep 5
  post:
    - docker-compose down

deployment:
  release:
    tag: /[0-9]+\.[0-9]+\.[0-9]+/tag
    owner: TheKevJames
    commands:
      - curl -L https://github.com/aktau/github-release/releases/download/v0.6.2/linux-amd64-github-release.tar.bz2 > github-release.tar.bz2
      - tar xjf github-release.tar.bz2
      - rm -f github-release.tar.bz2

      - ./bin/linux/amd64/github-release release --user TheKevJames --repo jarvis --tag $(git tag --sort=version:refname | tail -n1) --name "Jarvis" --description "$(git log $(git tag --sort=version:refname | tail -n2 | head -n1)..$(git tag --sort=version:refname | tail -n1) --pretty=format:'- %s')"
